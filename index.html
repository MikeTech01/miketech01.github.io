<script>
/* ==================== CONFIG ==================== */
const GH_USER = 'MikeTech01';        // <-- your GitHub username
const WEEKS_TO_SHOW = 10;
const BI_KEYWORDS = ['bi','business intelligence','dashboard','power bi','quicksight','analytics'];
const HOURS_GOAL = 10;               // weekly learning target

/* ==================== UTIL & DOM ==================== */
const $ = (s)=>document.querySelector(s);
const setText = (sel,val)=>{ const n=$(sel); if(n) n.textContent = val; };
const rmSkel = ()=> document.querySelectorAll('.kpi.skeleton').forEach(k=>k.classList.remove('skeleton'));
const cacheGet = (k,maxAgeMs)=>{ try{const v=localStorage.getItem(k); if(!v) return null; const {t,data}=JSON.parse(v); return (Date.now()-t<maxAgeMs)?data:null;}catch{return null;} };
const cacheSet = (k,data)=>{ try{localStorage.setItem(k, JSON.stringify({t:Date.now(),data}))}catch{} };

/* ==================== SVG DRAWERS ==================== */
function drawSparkline(svgId, data){
  const svg=document.getElementById(svgId); if(!svg||!data?.length) return;
  while(svg.lastChild) svg.removeChild(svg.lastChild);
  const W=600,H=180,L=40,R=20,T=10,B=30,max=Math.max(HOURS_GOAL+4,...data),stepX=(W-L-R)/(data.length-1);

  // axes
  const addLine=(x1,y1,x2,y2,st='#2e3a4a',dash)=>{ const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',x1);ln.setAttribute('y1',y1);ln.setAttribute('x2',x2);ln.setAttribute('y2',y2);ln.setAttribute('stroke',st); if(dash) ln.setAttribute('stroke-dasharray',dash); svg.appendChild(ln); }
  addLine(L,T,L,H-B); addLine(L,H-B, W-R,H-B);

  const pts=data.map((v,i)=>[L+i*stepX, T+(1-v/max)*(H-T-B)]);
  const d=pts.map((p,i)=>(i?'L':'M')+p[0]+' '+p[1]).join(' ');
  const fillD = d + ` L ${L+(data.length-1)*stepX} ${H-B} L ${L} ${H-B} Z`;

  // gradient
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  const grad=document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
  grad.id='slGrad'; grad.setAttribute('x1','0'); grad.setAttribute('y1','0'); grad.setAttribute('x2','0'); grad.setAttribute('y2','1');
  const s1=document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#FF9900');
  const s2=document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#146EB4'); s2.setAttribute('stop-opacity','0.2');
  grad.append(s1,s2); defs.appendChild(grad); svg.appendChild(defs);

  const fill=document.createElementNS('http://www.w3.org/2000/svg','path'); fill.setAttribute('d',fillD); fill.setAttribute('fill','url(#slGrad)'); fill.setAttribute('opacity','0.28'); svg.appendChild(fill);
  const path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d',d); path.setAttribute('fill','none'); path.setAttribute('stroke','#FF9900'); path.setAttribute('stroke-width','2.5'); svg.appendChild(path);

  const [lx,ly]=pts[pts.length-1]; const dot=document.createElementNS('http://www.w3.org/2000/svg','circle'); dot.setAttribute('cx',lx); dot.setAttribute('cy',ly); dot.setAttribute('r','4.5'); dot.setAttribute('fill','#FF9900'); svg.appendChild(dot);

  // goal line
  const gy=T+(1-HOURS_GOAL/max)*(H-T-B); addLine(L,gy, W-R,gy, '#3a4a5f', '4 4');
}

function drawBars(svgId, series){
  const svg=document.getElementById(svgId); if(!svg||!series?.length) return;
  while(svg.lastChild) svg.removeChild(svg.lastChild);
  const W=600,H=180,L=40,R=20,T=10,B=30,barW=((W-L-R)/series.length)*0.65,gap=((W-L-R)/series.length)*0.35,maxV=Math.max(1,...series.map(s=>s.value))*1.25;

  const axisX=document.createElementNS('http://www.w3.org/2000/svg','line');
  axisX.setAttribute('x1',L); axisX.setAttribute('x2',W-R); axisX.setAttribute('y1',H-B); axisX.setAttribute('y2',H-B); axisX.setAttribute('stroke','#2e3a4a'); svg.appendChild(axisX);

  series.forEach((s,i)=>{
    const x=L+i*(barW+gap)+gap*0.5, h=(s.value/maxV)*(H-T-B), y=(H-B)-h;
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',barW); rect.setAttribute('height',h); rect.setAttribute('rx','6'); rect.setAttribute('fill',s.color||'#7fb8ff'); rect.setAttribute('opacity','0.92'); svg.appendChild(rect);

    const label=document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x',x+barW/2); label.setAttribute('y',H-B+16); label.setAttribute('text-anchor','middle'); label.setAttribute('fill','#D6DEEE'); label.setAttribute('font-size','12'); label.textContent=s.label; svg.appendChild(label);

    const val=document.createElementNS('http://www.w3.org/2000/svg','text');
    val.setAttribute('x',x+barW/2); val.setAttribute('y',y-6); val.setAttribute('text-anchor','middle'); val.setAttribute('fill','#ffffff'); val.setAttribute('font-size','12'); val.textContent=s.value+(s.suffix||''); svg.appendChild(val);
  });
}

function drawDonut(svgId, percent){
  const svg=document.getElementById(svgId); if(!svg) return;
  while(svg.lastChild) svg.removeChild(svg.lastChild);
  const cx=100, cy=100, r=70, circ=2*Math.PI*r;
  const bg=document.createElementNS('http://www.w3.org/2000/svg','circle');
  bg.setAttribute('cx',cx); bg.setAttribute('cy',cy); bg.setAttribute('r',r); bg.setAttribute('fill','none'); bg.setAttribute('stroke','#2e3a4a'); bg.setAttribute('stroke-width','16'); svg.appendChild(bg);
  const fg=document.createElementNS('http://www.w3.org/2000/svg','circle');
  fg.setAttribute('cx',cx); fg.setAttribute('cy',cy); fg.setAttribute('r',r); fg.setAttribute('fill','none'); fg.setAttribute('stroke','#FF9900'); fg.setAttribute('stroke-width','16'); fg.setAttribute('stroke-linecap','round');
  fg.setAttribute('stroke-dasharray',`${circ*percent} ${circ}`); fg.setAttribute('transform','rotate(-90 100 100)'); svg.appendChild(fg);
  const t=document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x',cx); t.setAttribute('y',cy+6); t.setAttribute('text-anchor','middle'); t.setAttribute('fill','#ffffff'); t.setAttribute('font-size','22'); t.setAttribute('font-weight','700');
  t.textContent = Math.round(percent*100)+'%'; svg.appendChild(t);
}

function drawBeforeAfter(svgId, beforeVal, afterVal, label='Latency (ms)'){
  const svg=document.getElementById(svgId); if(!svg) return;
  while(svg.lastChild) svg.removeChild(svg.lastChild);
  const W=600,H=180,L=40,R=20,T=20,B=40,max=Math.max(beforeVal,afterVal)*1.15, barW=90, gap=80, yBase=H-B;

  const addBar=(x,val,color)=>{ const h=(val/max)*(H-T-B),y=yBase-h; const r=document.createElementNS('http://www.w3.org/2000/svg','rect'); r.setAttribute('x',x); r.setAttribute('y',y); r.setAttribute('width',barW); r.setAttribute('height',h); r.setAttribute('rx','8'); r.setAttribute('fill',color); r.setAttribute('opacity','0.95'); svg.appendChild(r); return {x,y,h}; };
  // axis
  const axis=document.createElementNS('http://www.w3.org/2000/svg','line'); axis.setAttribute('x1',L); axis.setAttribute('x2',W-R); axis.setAttribute('y1',yBase); axis.setAttribute('y2',yBase); axis.setAttribute('stroke','#2e3a4a'); svg.appendChild(axis);

  const x1=L+80, x2=x1+barW+gap;
  addBar(x1,beforeVal,'#7fb8ff'); addBar(x2,afterVal,'#FF9900');

  const tx=(x,text,y)=>{ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',x); t.setAttribute('y',y); t.setAttribute('text-anchor','middle'); t.setAttribute('fill','#D6DEEE'); t.setAttribute('font-size','12'); t.textContent=text; svg.appendChild(t); };
  tx(x1+barW/2,'Before',yBase+16); tx(x2+barW/2,'After',yBase+16);
  const title=document.createElementNS('http://www.w3.org/2000/svg','text'); title.setAttribute('x', (W/2)); title.setAttribute('y', T-6); title.setAttribute('text-anchor','middle'); title.setAttribute('fill','#D6DEEE'); title.setAttribute('font-size','12'); title.textContent=label; svg.appendChild(title);

  // values
  const valT=(x,val,y)=>{ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',x); t.setAttribute('y',y); t.setAttribute('text-anchor','middle'); t.setAttribute('fill','#ffffff'); t.setAttribute('font-size','13'); t.textContent=val; svg.appendChild(t); };
  valT(x1+barW/2, beforeVal, T+16); valT(x2+barW/2, afterVal, T+16);
}

/* ==================== GITHUB FETCHERS ==================== */
async function fetchJSON(url){
  const res = await fetch(url, { headers:{'Accept':'application/vnd.github+json'} });
  if(!res.ok) throw new Error(res.status+' '+res.statusText);
  return res.json();
}
async function fetchRepos(user){
  return (await fetchJSON(`https://api.github.com/users/${user}/repos?per_page=100&type=owner&sort=updated`)).filter(r=>!r.fork);
}
async function fetchEvents(user){   // last ~300 public events
  return fetchJSON(`https://api.github.com/users/${user}/events/public`);
}

/* ==================== RENDER ==================== */
async function renderSnapshot(){
  const cacheKey='gh_snapshot_v1';
  const cached = cacheGet(cacheKey, 1000*60*15); // 15 minutes
  let data = cached;
  try{
    if(!data){
      const [repos, events] = await Promise.all([ fetchRepos(GH_USER), fetchEvents(GH_USER) ]);

      // KPIs
      const projects = repos.length;
      const stars = repos.reduce((s,r)=>s+(r.stargazers_count||0),0);
      const dashboards = repos.filter(r=>{
        const blob = `${r.name||''} ${(r.description||'')} ${(r.topics||[]).join(' ')}`.toLowerCase();
        return BI_KEYWORDS.some(k=>blob.includes(k));
      }).length;

      // Weekly commits (map to ~hours)
      const weeks = Array(WEEKS_TO_SHOW).fill(0);
      const now = new Date();
      const isoWeekStart = (d)=>{ const dt=new Date(d); const day=(dt.getUTCDay()+6)%7; dt.setUTCDate(dt.getUTCDate()-day); dt.setUTCHours(0,0,0,0); return dt; };
      const thisWeek = isoWeekStart(now);
      events.forEach(ev=>{
        if(ev.type!=='PushEvent') return;
        const when = new Date(ev.created_at);
        const ws = isoWeekStart(when);
        const diffDays = (thisWeek - ws)/(1000*60*60*24);
        const idxFromEnd = Math.floor(diffDays/7);
        const bucket = (WEEKS_TO_SHOW-1) - idxFromEnd;
        if(bucket>=0 && bucket<WEEKS_TO_SHOW) weeks[bucket] += (ev?.payload?.size||0);
      });
      const hours = weeks.map(c=>Math.min(15, Math.round(c*1.0))); // 1 commit ≈ 1h
      const thisWeekHours = hours[hours.length-1] || 0;

      // Language split (top 3)
      const counts={}; repos.forEach(r=>{ const k=r.language||'Other'; counts[k]=(counts[k]||0)+1; });
      const langSeries = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([label,value],i)=>({
        label, value, color: i===0?'#FF9900':i===1?'#3aa0ff':'#7fb8ff'
      }));

      data = {projects, stars, dashboards, hours, thisWeekHours, langSeries};
      cacheSet(cacheKey, data);
    }

    // --- write KPIs
    setText('#kpi-projects', data.projects);
    setText('#kpi-dashboards', data.dashboards);
    setText('#kpi-stars', data.stars);
    setText('#kpi-projects-delta', 'from GitHub');
    setText('#kpi-dashboards-delta', data.dashboards ? 'keywords/topics match' : 'no BI-tagged repos yet');
    setText('#kpi-stars-delta', 'public repo stars total');

    // Goal KPI
    const pct = Math.max(0, Math.min(1, data.thisWeekHours / HOURS_GOAL));
    setText('#kpi-goal', Math.round(pct*100)+'%');
    setText('#kpi-goal-note', `${data.thisWeekHours}h / ${HOURS_GOAL}h`);

    // Skeleton off
    rmSkel();

    // --- charts
    drawSparkline('sparkline', data.hours);
    drawBars('barchart', data.langSeries);
    drawDonut('donut', pct);

    // Before/After demo (edit with your real values)
    drawBeforeAfter('beforeAfter', 950, 620, 'Latency (ms) — Before vs After');
    document.getElementById('ba-legend').textContent = 'Example: −35% latency after pipeline changes';

    // Legend for sparkline
    const avg = (data.hours.reduce((a,b)=>a+b,0) / (data.hours.length||1)).toFixed(1);
    setText('#sparkline-legend', `Last ${WEEKS_TO_SHOW} weeks · avg ${avg}h/wk`);

    // API status
    setText('#api-status', 'GitHub API: OK (cached ' + (cacheGet('gh_snapshot_v1', 1e12)?'✓':'—') + ')');
  } catch (err){
    console.warn(err);
    setText('#api-status', 'GitHub API error or rate limit — showing placeholders.');
    rmSkel();
  }
}

renderSnapshot();
</script>
